
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <title>Todo Culebra ‚Ä¢ Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { margin: 0; height: 100vh; }
    #map { height: 100%; width: 100%; }
    .emoji-marker {
      font-size: 34px;
      text-shadow: 0 2px 6px rgba(0,0,0,0.6);
      line-height: 1;
      user-select: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- Map setup ---
    const map = L.map('map').setView([18.3035, -65.2998], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // --- Emoji marker helpers ---
    function makeEmojiIcon(emoji) {
      return L.divIcon({
        className: "",
        html: `<div class="emoji-marker">${emoji}</div>`,
        iconSize: [40, 40],
        iconAnchor: [20, 20],
        popupAnchor: [0, -20]
      });
    }

    function chooseEmoji(name = '') {
      const lower = name.toLowerCase();
      if (lower.includes("taco") || lower.includes("zaco")) return "üåÆ";
      if (lower.includes("pizza")) return "üçï";
      if (lower.includes("hub") || lower.includes("todo culebra")) return "üßê";
      return "üìç";
    }

    // --- Utility: unescape HTML entities like &lt; &gt; in description strings ---
    function htmlDecode(str = '') {
      const txt = document.createElement('textarea');
      txt.innerHTML = str;
      return txt.value;
    }

    // --- Load external JSON ---
    (async function loadLocations() {
      // If data.json is at the site root: use '/data.json'
      // If it's next to this HTML file: use 'data.json'
      // If it's in /data/: use '/data/data.json'
      const url = 'data.json?ts=' + Date.now(); // <-- adjust if needed

      try {
        const res = await fetch(url, { cache: 'no-store' });

        // Debug info to console
        console.log('Fetch URL:', url);
        console.log('HTTP status:', res.status);
        console.log('Content-Type:', res.headers.get('content-type'));

        const raw = await res.text();
        console.log('Response preview:', raw.slice(0, 200));

        if (!res.ok) {
          throw new Error(`HTTP ${res.status} on ${url}\n${raw}`);
        }

        // Parse JSON (even if server sent text/plain)
        let data;
        try {
          data = JSON.parse(raw);
        } catch (e) {
          throw new Error('JSON parse error. The response is not valid JSON.\n' + e.message);
        }

        if (!data.locations || !Array.isArray(data.locations)) {
          throw new Error('Invalid JSON: expected an object with a "locations" array.');
        }

        const markers = [];

        data.locations.forEach(loc => {
          const { lat, lng, name, description } = loc;
          if (typeof lat !== 'number' || typeof lng !== 'number') {
            console.warn('Skipping location with invalid lat/lng:', loc);
            return;
          }

          const icon = makeEmojiIcon(chooseEmoji(name));
          const marker = L.marker([lat, lng], { icon }).addTo(map);

          // Decode entities so links like &lt;a href=...&gt; render correctly
          const decodedDesc = htmlDecode(description);

          marker.bindPopup(`
            <b>${name ?? 'Unnamed'}</b><br />
            ${decodedDesc ?? ''}
          `);

          markers.push(marker);
        });

        if (markers.length) {
          const bounds = L.latLngBounds(markers.map(m => m.getLatLng()));
          map.fitBounds(bounds, { padding: [30, 30] });
        } else {
          console.warn('No markers created from data.json');
        }
      } catch (err) {
        console.error('Error loading locations:', err);
        alert('There was a problem loading the locations. Open DevTools ‚Üí Console for details.');
      }
    })();
  </script>
</body>
</html>
