
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
  />
  <title>Todo Culebra ‚Ä¢ Map</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    :root {
      --bg: #0b1220;         /* deep navy */
      --fg: #f1f5f9;         /* near-white */
      --accent: #00c2a8;     /* teal accent */
      --accent-dark: #009883;
    }

    /* Reset and layout */
    html, body {
      margin: 0; padding: 0;
      height: 100%;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    /* Welcome screen styles */
    .welcome {
      position: fixed;
      inset: 0; /* top/right/bottom/left: 0 */
      display: grid;
      place-items: center;
      background: radial-gradient(1200px 800px at 30% 20%, #13203a, var(--bg));
      z-index: 9999;
    }

    .welcome-inner {
      text-align: center;
      max-width: 720px;
      padding: 24px;
      animation: fadeInUp 600ms ease both;
    }

    .brand {
      font-size: 2.25rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    .tagline {
      font-size: 1.05rem;
      opacity: 0.85;
      margin-bottom: 26px;
    }

    .cta {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 14px 22px;
      border-radius: 10px;
      background: var(--accent);
      color: #062b27;
      font-weight: 700;
      font-size: 1.05rem;
      border: none;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0, 194, 168, 0.35);
      transition: transform 140ms ease, box-shadow 140ms ease, background 140ms ease;
    }
    .cta:focus { outline: 2px solid #82efe0; outline-offset: 3px; }
    .cta:hover { transform: translateY(-1px); background: var(--accent-dark); }
    .cta:active { transform: translateY(0); box-shadow: 0 3px 10px rgba(0, 194, 168, 0.28); }

    .supporting {
      margin-top: 18px;
      font-size: 0.95rem;
      opacity: 0.8;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Map container (initially hidden) */
    #map {
      height: 100vh;
      width: 100%;
      display: none; /* hidden until user clicks */
    }

    /* Emoji marker styling */
    .emoji-marker {
      font-size: 34px;
      text-shadow: 0 2px 6px rgba(0,0,0,0.6);
      line-height: 1;
      user-select: none;
    }

    /* Small helper: subtle footer link on welcome */
    .welcome-footer {
      position: fixed;
      bottom: 14px;
      width: 100%;
      text-align: center;
      font-size: 0.9rem;
      opacity: 0.6;
    }

    .link {
      color: #80ffe9;
      text-decoration: none;
    }
    .link:hover { text-decoration: underline; }
  </style>
</head>
<body>

  <!-- Welcome Screen -->
  <section class="welcome" id="welcome" aria-labelledby="welcome-title" role="dialog" aria-modal="true">
    <div class="welcome-inner">
      <h1 class="brand" id="welcome-title">Welcome to InCulebra</h1>
      <p class="tagline">Explore spots, hubs, restaurants, and more across Culebra.</p>

      <button class="cta" id="showMapBtn" type="button" aria-controls="map" aria-expanded="false">
        <span>üó∫Ô∏è Culebra Map</span>
      </button>

      <p class="supporting">Tap the button to load the interactive map.</p>
    </div>

    <div class="welcome-footer">
      <span>Powered by OpenStreetMap & Leaflet</span>
      &nbsp;‚Ä¢&nbsp;
      <a class="link" href="https://www.shopculebra.com" target="_blank" rel="noopener">Order at ShopCulebra</a>
    </div>
  </section>

  <!-- Map -->
  <div id="map" role="region" aria-label="Culebra map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Remember user's choice to skip welcome next time (optional)
    const STORAGE_KEY = 'inculebra_skip_welcome';

    const welcomeEl = document.getElementById('welcome');
    const mapEl = document.getElementById('map');
    const btn = document.getElementById('showMapBtn');

    // If user has visited and clicked before, skip welcome
    const skipWelcome = localStorage.getItem(STORAGE_KEY) === 'yes';
    if (skipWelcome) {
      welcomeEl.style.display = 'none';
      mapEl.style.display = 'block';
      btn.setAttribute('aria-expanded', 'true');
      initMapAndData(); // initialize immediately
    }

    // Button behavior
    btn.addEventListener('click', () => {
      // Hide welcome, show map
      welcomeEl.style.display = 'none';
      mapEl.style.display = 'block';
      btn.setAttribute('aria-expanded', 'true');

      // Persist preference
      localStorage.setItem(STORAGE_KEY, 'yes');

      // Initialize map & load data
      initMapAndData();
    });

    // --- Map & data initialization (called only when map is shown) ---
    function initMapAndData() {
      // Map setup
      const map = L.map('map').setView([18.3035, -65.2998], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // Emoji marker helpers
      function makeEmojiIcon(emoji) {
        return L.divIcon({
          className: "",
          html: `<div class="emoji-marker">${emoji}</div>`,
          iconSize: [40, 40],
          iconAnchor: [20, 20],
          popupAnchor: [0, -20]
        });
      }

      function chooseEmoji(name = '') {
        const lower = name.toLowerCase();
        if (lower.includes("tacos")) return "üëâüåÆ";
        if (lower.includes("beach")) return "üëâ‚õ±Ô∏èü§ø";
        if (lower.includes("pizza")) return "üëâüçï";
        if (lower.includes("playa")) return "üëâ‚õ±Ô∏è";
        if (lower.includes("hub") || lower.includes("todo culebra")) return "üëâüå¥";
        return "üìç";
      }

      // Unescape HTML entities like &lt; &gt; in description strings
      function htmlDecode(str = '') {
        const txt = document.createElement('textarea');
        txt.innerHTML = str;
        return txt.value;
      }

      // Load external JSON (unchanged path; adjust if needed)
      (async function loadLocations() {
        const url = 'data.json?ts=' + Date.now(); // cache-bust but do not alter JSON content

        try {
          const res = await fetch(url, { cache: 'no-store' });

          // Debug info to console
          console.log('Fetch URL:', url);
          console.log('HTTP status:', res.status);
          console.log('Content-Type:', res.headers.get('content-type'));

          const raw = await res.text();
          console.log('Response preview:', raw.slice(0, 200));

          if (!res.ok) {
            throw new Error(`HTTP ${res.status} on ${url}\n${raw}`);
          }

          // Parse JSON (even if server sent text/plain)
          let data;
          try {
            data = JSON.parse(raw);
          } catch (e) {
            throw new Error('JSON parse error. The response is not valid JSON.\n' + e.message);
          }

          if (!data.locations || !Array.isArray(data.locations)) {
            throw new Error('Invalid JSON: expected an object with a "locations" array.');
          }

          const markers = [];

          data.locations.forEach(loc => {
            const { lat, lng, name, description } = loc;
            if (typeof lat !== 'number' || typeof lng !== 'number') {
              console.warn('Skipping location with invalid lat/lng:', loc);
              return;
            }

            const icon = makeEmojiIcon(chooseEmoji(name));
            const marker = L.marker([lat, lng], { icon }).addTo(map);

            // Decode entities so links like &lt;a href=...&gt; render correctly
            const decodedDesc = htmlDecode(description);

            marker.bindPopup(`
              <b>${name ?? 'Unnamed'}</b><br />
              ${decodedDesc ?? ''}
            `);

            markers.push(marker);
          });

          if (markers.length) {
            const bounds = L.latLngBounds(markers.map(m => m.getLatLng()));
            map.fitBounds(bounds, { padding: [30, 30] });
          } else {
            console.warn('No markers created from data.json');
          }
        } catch (err) {
          console.error('Error loading locations:', err);
          alert('There was a problem loading the locations. Open DevTools ‚Üí Console for details.');
        }
      })();
    }
  </script>
</body>
</html>



